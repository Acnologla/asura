FROM golang:alpine AS builder
ENV GOOS=linux \
    GOARCH=amd64

WORKDIR /build

COPY go.mod .
RUN go mod tidy

COPY . .
RUN env GOOS=linux GOARCH=arm64 go build -mod=mod -o main .

FROM alpine

WORKDIR /dist

ARG TOKEN
ARG PUBLIC_KEY
ARG APP_ID
ARG TOP_TOKEN
ARG FIREBASE_CONFIG
ARG FIREBASE_PROJECT_ID
ARG DATADOG_API_KEY
ARG DB_CONFIG
ARG REDIS_CONFIG


ENV PUBLIC_KEY=$PUBLIC_KEY
ENV APP_ID=$APP_ID
ENV PRODUCTION=TRUE
ENV TOP_TOKEN=$TOP_TOKEN
ENV TOKEN=$TOKEN
ENV FIREBASE_CONFIG=$FIREBASE_CONFIG
ENV FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID
ENV DATADOG_API_KEY=$DATADOG_API_KEY
ENV DB_CONFIG=$DB_CONFIG
ENV REDIS_CONFIG=$REDIS_CONFIG

COPY --from=builder /build/main /dist
COPY --from=builder /build/resources /dist/resources
COPY --from=builder /build/i18n /dist/i18n

ENTRYPOINT ./main 